{{/*
Renders a list of direct child Sections or RegularPages for a Hugo section.

Specifically, this renders one of the following options:
1. If this a Section with *any* child Sections, then each child Section *and* its child RegularPages are listed.
2. Otherwise, *all* child RegularPages are listed - any child Sections are ommitted.

This is specific to the ScratchBuffer content structure which has the following properties:
* A top-level section only has child sections, no direct child pages
* A second-level section only has child pages, no further child sections.

@context {page} page The current Section to render.

@example: {{ partial "section-pages-list.html" . }}
*/}}

{{- $page := .page }}
{{- $articleType := "article" }}
{{- $notecardType := "notecard" }}
{{- $regularPageTypes := slice $articleType $notecardType }}
{{- $pageTypesListHeader := dict $articleType "Articles" $notecardType "Note Cards"}}

<div class="section-pages-list">

    {{- if $page.Sections }}
      <!--
      This is a list page for a Section containing further Sections.
      The content structure does not use Sections with both direct child Sections and direct child RegularPages
      -->
      {{- $pagesByType := dict }}

      {{- range sort $page.Sections ".Params.weight" }}
        {{ $page := . }}


        {{- $pagesByType := dict }}

        {{- range $regularPageTypes }}
          {{- $pageListForType := (sort (where $page.RegularPages "Type" "eq" .) ".Params.weight")}}
          {{- if gt (len $pageListForType) 0 }}
            {{- $pagesByType = merge $pagesByType (dict . $pageListForType) }}
          {{ end }}
        {{ end }}

        <!-- Now do things for each Type if we have them -->
        {{ if gt (len $pagesByType) 0 }}
          <!--
          We at least have RegularPages for one Type in this Section.
          Show the Section header and start the list.
          -->
          <div class="sections-list">
            <div class="sections-list-header">
            <a href="{{ $page.RelPermalink }}">
              <h2>{{ $page.Title }}</h2>
            </a>
            </div>
            <ul>
                <!-- Create a nested list for each Type that has of RegularPages -->
                {{- range $regularPageTypes }} <!-- Ensure we go in desired order as dict is unordered -->
                  {{ $pageType := . }}
                  {{- $pageListForType := index $pagesByType $pageType }}
                  {{- with $pageListForType }}
                  <div class="pages-list">
                  <div class="pages-list-header">
                    <h3>{{ index $pageTypesListHeader $pageType }}</h3>
                    <ul>
                        {{- range $pageListForType }}
                          <li>
                            {{
                              partial "page-header-simple.html"
                              (dict "page" . "titleElement" "h4" "descElement" "h5" "titleIsLink" true)
                            }}
                          </li>
                        {{- end }}
                    </ul>
                  </div>
                </div>
                    {{ end }}

                {{ end }}
            </ul>
          </div>
        {{ end }}
      {{ end }}

    {{- else if $page.RegularPages }} <!-- List direct child RegularPages which are not Sections-->
      <div class="pages-list">
        {{- range $regularPageTypes }}
          {{- $pageList := (sort (where $page.RegularPages "Type" "eq" .) ".Params.weight")}}
          {{- if gt (len $pageList) 0 }}
          <div class="pages-list-header">
            <h2>{{ index $pageTypesListHeader . }}</h2>
            <ul>
                {{- range $pageList }}
                  <li>{{ partial "page-header-simple.html" (dict "page" . "titleElement" "h3" "descElement" "h4" "titleIsLink" true) }}</li>
                {{- end }}
            </ul>
          </div>
          {{ end }}
        {{ end }}
      </div>
    {{- end }}
</div>